<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.0, shrink-to-fit=no, user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="title" content="花萼横江"><meta name="sub title"><meta name="description" content="花萼横江"><meta name="key words"><meta name="author" content="王品"><meta name="language" content="zh-CN"><title>gulp 拾遗 (2) - 认识 glob</title><link rel="stylesheet" type="text/css" href="/css/reset.css"><link rel="stylesheet" type="text/css" href="/css/index.css"><link rel="stylesheet" type="text/css" href="/css/nav.css"><link rel="stylesheet" type="text/css" href="/css/wigets.css"><link rel="stylesheet" type="text/css" href="/css/code.css"></head><body> <nav><div class="top-bar">花萼横江</div><label class="mobile-menu"><input type="checkbox"><div class="items"><a href="/">首页</a><a href="/about">关于</a><a href="/projects">项目</a><a href="/archives">归档</a></div><div class="overlap"></div></label></nav><section class="body"><article><header><h1><a href="/2018/12/26/gulp-series-2-glob/">gulp 拾遗 (2) - 认识 glob</a></h1><div class="metadata">创建于 2018年12月26日   最后一次更新于 2021-03-03 03:11</div></header><main><h1><span id="为什么要用-glob">为什么要用 glob</span></h1>
<p>gulp 的 <a href="https://gulpjs.com/docs/en/getting-started/creating-tasks" target="_blank" rel="noopener">task</a> 函数一般起自于 <a href="https://gulpjs.com/docs/en/api/src" target="_blank" rel="noopener">src</a> ：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; src, dest &#125; = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> src(<span class="string">'input/*.js'</span>)</span><br><span class="line">    .pipe(dest(<span class="string">'output/'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说， <strong>src</strong> API 根据输入参数（input/*.js），从文件系统中读取文件流（stream），从而进行后续的操作。src 函数的第一个输入参数称为 pattern，是一个 glob 语句。glob 语句类似于 unix shell 中描述文件的方式。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ls ./input/*.js</span><br></pre></td></tr></table></figure>
<p>glob 语句很容易理解，比如上面的 input/<em>.js，表示 input 目录下（不包含子目录），扩展名为 js 的</em><em>所有</em>*文件。</p>
<p>如果想要自如的编写 gulp 脚本，掌握 glob 语句是必不可少的。事实上不只 gulp，其他构建工具如 webpack，也使用 glob 语句来匹配文件。我想原因无非有两个，一是因为 glob 语法非常简单，容易学习。另一方面， glob 借鉴了 unix/linux 中文件匹配的语法，而很多工程师都有 unix/linux 经验，学习成本很低。就像当年 android 使用 java 作为开发语言以至于收到很多 java 程序员的喜爱和支持。</p>
<h1><span id="node-glob">node-glob</span></h1>
<p>目前，glob 最好的实现应该是 <a href="https://github.com/isaacs/node-glob" target="_blank" rel="noopener">node-glob</a>。下面是一个简单的例子，用于查找所有目录下的 js 文件。第一个参数称为 pattern，描述待匹配文件的路径特征；第二个参数是 options，提供一些增强的配置项，如配置工作目录，模式，排序规则，等等。第三个参数是回调函数。可以看到 glob 是异步函数。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> glob = <span class="built_in">require</span>(<span class="string">"glob"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// options is optional</span></span><br><span class="line">glob(<span class="string">"**/*.js"</span>, options, <span class="function"><span class="keyword">function</span> (<span class="params">er, files</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// files is an array of filenames.</span></span><br><span class="line">  <span class="comment">// If the `nonull` option is set, and nothing</span></span><br><span class="line">  <span class="comment">// was found, then files is ["**/*.js"]</span></span><br><span class="line">  <span class="comment">// er is an error object or null.</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2><span id="pattern">pattern</span></h2>
<p>pattern 的类型是字符串或者字符串数组，每个字符串都可以包含以下几种关键字。</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">* 匹配 <span class="number">0</span> 或多个字符</span><br><span class="line">? 匹配 <span class="number">1</span> 个字符</span><br><span class="line">[...] 匹配一系列字符，比如 [a-z], [<span class="number">0</span><span class="number">-9</span>]。如果第一个字符是 ！ 或 ^， 则匹配不在其中的字符。比如 [^a-z] 匹配不是 a-z 之外的字符。</span><br><span class="line">!(<span class="built_in">pattern</span>|<span class="type">pattern</span>|<span class="type">pattern</span>) 匹配不符合所有 <span class="built_in">pattern</span> 的字符</span><br><span class="line">?(<span class="built_in">pattern</span>|<span class="type">pattern</span>|<span class="type">pattern</span>) 匹配 <span class="number">0</span> 或 <span class="number">1</span> 个符合其中一个 <span class="built_in">pattern</span> 的内容</span><br><span class="line">+(<span class="built_in">pattern</span>|<span class="type">pattern</span>|<span class="type">pattern</span>) 匹配 <span class="number">1</span> 或多个符合至少其中一个 <span class="built_in">pattern</span> 的内容</span><br><span class="line">*(a|<span class="type">b</span>|<span class="type">c</span>) 匹配 <span class="number">0</span> 或多个符合至少其中一个 <span class="built_in">pattern</span> 的内容</span><br><span class="line">@(<span class="built_in">pattern</span>|<span class="type">pat</span>*|<span class="type">pat</span>?erN) 匹配 <span class="number">1</span>个至少符合其中一个 <span class="built_in">pattern</span> 的内容</span><br><span class="line">** 两个星号匹配 <span class="number">0</span> 或多个目录</span><br></pre></td></tr></table></figure>
<p>上面的规则不算太复杂（相比正则表达式），但仍需要搭配一些练习才能掌握。</p>
<h2><span id="options">options</span></h2>
<p><a href="(https://gulpjs.com/docs/en/api/src#options)">options</a> 中的选项很多，拣几个常用的讲一下。</p>
<h3><span id="cwd">cwd</span></h3>
<p>cwd 表示当前工作目录（current work directory）。也就是 process.cwd()，也即使 nodejs 脚本的执行目录。什么意思呢？比如，有个文件 index.js，我们在 /home/wangpin 下执行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/home/wangpin $ node index.js</span><br></pre></td></tr></table></figure>
<p>此时，cwd 是 /home/wangpin。<br>
如果我们在 home 目录下启动 index.js：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/home $ node wangpin/index.js</span><br></pre></td></tr></table></figure>
<p>此时，cwd 是 /home。</p>
<p>简单的说，** cwd 是我们运行脚本的目录，不是脚本的存放目录 **。</p>
<h3><span id="ignore">ignore</span></h3>
<p>设置一个 pattern 用于忽略某些文件。虽然有 ! 和 ^ 可以用来做 exclude，但总体来说， pattern 是用来做 include，在其中夹杂复杂的 exclude 规则会让整个 pattern 变得非常难以理解。更简单的办法是利用 ignore option 来设置过滤规则。即</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">files</span> <span class="literal">-</span><span class="literal">-</span> <span class="comment">pattern:</span> <span class="comment">include</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">files</span> <span class="literal">-</span><span class="literal">-</span> <span class="comment">ignore:</span> <span class="comment">exclude</span> <span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">files</span></span><br></pre></td></tr></table></figure>
<p>比如，选取 input 目录下的 js 文件，同时过滤掉 min.js 文件：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">glob(<span class="string">'./input/*.js'</span>, &#123;<span class="attr">ignore</span>: <span class="string">'./input/*.min.js'</span>&#125;)</span><br></pre></td></tr></table></figure>
<h1><span id="gulp-中的-glob">gulp 中的 glob</span></h1>
<p>gulp 并没有直接使用 node-glob，它自己做了很多的封装，创造出了 <a href="https://github.com/gulpjs/glob-stream" target="_blank" rel="noopener">glob-stream</a>，<a href="https://github.com/gulpjs/vinyl-fs" target="_blank" rel="noopener">vinyl-fs</a> 等一系列满足自身需求，同时也很有现实意义的库。gulp 的官方文档中队 vinyl 和 glob 也做了详细的阐释，请移步 <a href="https://gulpjs.com/docs/en/api/" target="_blank" rel="noopener">concepts</a>。</p>
<h1><span id="其他脚本中的-glob">其他脚本中的 glob</span></h1>
<p>编写任何涉及到文件检索的脚本，glob 都应该是首选。比如，我们想要将 dist 目录中的所有文件上传到 aws s3。如果用 fs api 生写，仅仅是遍历所有文件，就需要下面这一大段代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deploy</span>(<span class="params">src</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> totalFiles = []</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">listFiles</span>(<span class="params">folder</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fs.readdirAsync(folder)</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span>(<span class="params">list</span>)</span>&#123;</span><br><span class="line">        list = list.map(<span class="function"><span class="keyword">function</span>(<span class="params">f</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> path.join(folder, f)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">let</span> files = list.filter(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> fs.statSync(file).isFile()</span><br><span class="line">        &#125;)</span><br><span class="line">        totalFiles = totalFiles.concat(files)</span><br><span class="line">        <span class="keyword">let</span> folders = list.filter(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> fs.statSync(file).isDirectory()</span><br><span class="line">        &#125;)</span><br><span class="line">          .map(<span class="function"><span class="keyword">function</span>(<span class="params">folder</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> listFiles(folder)</span><br><span class="line">          &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.all(folders)</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.error(e)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> listFiles(src)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.all(totalFiles.map(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> put(file, src)</span><br><span class="line">      &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这还没有涉及复杂的 include 和 exclude 规则，已经是比较<strong>大</strong>的函数了。<br>
如果用 glob 重构一下呢？</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deploy</span>(<span class="params">globs, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">      glob(globs, opts, <span class="function"><span class="keyword">function</span>(<span class="params">err, files</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err)</span><br><span class="line">        &#125;</span><br><span class="line">        resolve(files.filter(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> fs.statSync(file).isFile()</span><br><span class="line">        &#125;))</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;))</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">files</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.all(files.map(<span class="function"><span class="keyword">function</span>(<span class="params">file</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> put(file)</span><br><span class="line">      &#125;))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码量减少的同时，复杂的include/exclude部分由专业的 glob 来负责。</p>
<h1><span id="总结">总结</span></h1>
<p>glob 是简单而强大的文件匹配库，gulp，webpack 等构架工具都使用它来简单化文件匹配工作，某种意义上来说它已经是文件匹配的事实标准。glob 也可以用于其他涉及文件匹配的应用场景，不必拘泥于已有的场合。</p>
<p>文中提到的库，文档，及相关资料地址。</p>
<ul>
<li><a href="https://github.com/isaacs/node-glob" target="_blank" rel="noopener">node-glob</a></li>
<li><a href="https://gulpjs.com/docs/en/api/concepts" target="_blank" rel="noopener">gulp concepts</a></li>
<li><a href="https://gulpjs.com/docs/en/getting-started/explaining-globs" target="_blank" rel="noopener">gulp expaining globs</a></li>
</ul>
</main></article></section><footer><section class="links"> <a href="atom.xml"> <span class="icon" name="rss"></span></a><a href="https://github.com/wangpin34"> <span class="icon" name="github"></span></a><a href="https://hexo.io">Hexo</a></section><section class="copyright">© 2019 王品</section></footer></body></html>