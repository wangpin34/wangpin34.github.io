<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.0, shrink-to-fit=no, user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="title" content="花萼横江"><meta name="sub title"><meta name="description" content="花萼横江"><meta name="key words"><meta name="author" content="王品"><meta name="language" content="zh-CN"><title>不再为折腾环境变量而哭泣</title><link rel="stylesheet" type="text/css" href="/css/reset.css"><link rel="stylesheet" type="text/css" href="/css/index.css"><link rel="stylesheet" type="text/css" href="/css/nav.css"><link rel="stylesheet" type="text/css" href="/css/wigets.css"><link rel="stylesheet" type="text/css" href="/css/code.css"></head><body> <nav><div class="top-bar">花萼横江</div><label class="mobile-menu"><input type="checkbox"><div class="items"><a href="/">首页</a><a href="/about">关于</a><a href="/projects">项目</a><a href="/archives">归档</a></div><div class="overlap"></div></label></nav><section class="body"><article><header><h1><a href="/2019/05/27/configure-env-variables-without-tears/">不再为折腾环境变量而哭泣</a></h1><div class="metadata">创建于 2019年05月27日   最后一次更新于 2021-03-03 03:11</div></header><main><p>create-react-app 提供了丰富的配置环境变量的方式，比如，可以创建 .env, .env.development, .env.production 三个文件：</p>
<ul>
<li>.env ： 默认变量</li>
<li>.env.development: 开发环境变量</li>
<li>.env.production: 线上环境变量</li>
</ul>
<p>上面的结构很适合只需要区分开发环境和线上环境的业务场景，也只能适用于这种场景。而实际的情况可能更加复杂，比如，我现在所负责的项目，线上环境就有四个，分别是 dev/qa/stg/prod（称为 stack）。cra 提供的方法完全不够用。事实上，create-react-app 在 github 上的 issue 中就有讨论过相关的 topic，当然，目前还没有定论。否则，我也不会在折腾半天无果后，只能自己造轮子，然后写下这篇造后感。</p>
<h2><span id="idea-of-spring">idea of spring</span></h2>
<p><strong>遇到前端工程问题，不妨看看后端有什么现成的解法</strong>。刚好我用过 spring，它引入一种概念叫做 profile，一个 sprint app 可以包含多个 profile，每个 profile 是一份配置文件。可以在主配置文件中设置当前启用哪个 profile。比如，对于我们的项目，可以配置 dev/qa/stg/prod 四个 profile。实际应用中，spring app 从环境变量中读取当前启用的 profile 的名字。比如，虚拟机中设置一个环境变量 profile=dev，则 dev profile 被启用。</p>
<h2><span id="cra-能做什么">cra 能做什么</span></h2>
<p>看完 spring 的 idea，来分析下 create-react-app 的现状。</p>
<ol>
<li>cra 预置 NODE_ENV 作为环境变量，当运行 start 命令时，值为 development，当运行 build 时，值为 production。但我们要区分 4 个线上环境，所以，无用。</li>
<li>cra 设置了复杂的配置文件优先级策略，详见官网，结论依然是无用。我个人倾向于简洁直白，每个环境需要的变量最好全部写清楚，不需要<strong>继承</strong>或者<strong>组合</strong>。</li>
</ol>
<p>所以，cra本身的高级机制我们统统不用，只需要知道 cra 会读取 .env 文件，无论是 development 还是 production。</p>
<h2><span id="模仿-spring">模仿 spring</span></h2>
<p>先准备好四个 profile 文件：</p>
<ul>
<li>.env.dev</li>
<li>.env.qa</li>
<li>.env.stg</li>
<li>.env.prod<br>
.env.dev 中内容，其他 profile 结构类似：</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">api_path: http://api.dev.com</span><br></pre></td></tr></table></figure>
<p>然后，根据环境变量 profile 切换 .env，即动态生成 .env 文件。</p>
<p>env.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> ini = <span class="built_in">require</span>(<span class="string">'ini'</span>)</span><br><span class="line"><span class="keyword">const</span> dotenv = <span class="built_in">require</span>(<span class="string">'dotenv'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.profile) &#123;</span><br><span class="line">    <span class="keyword">return</span> dotenv.config(&#123; <span class="attr">path</span>: path.join(__dirname, <span class="string">'..'</span>, <span class="string">`.env.<span class="subst">$&#123;process.env.profile&#125;</span>`</span>) &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dotenv.config()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = load()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">  <span class="keyword">throw</span> result.error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(result.parsed)</span><br><span class="line"></span><br><span class="line">fs.writeFileSync(<span class="string">'./.env'</span>, ini.stringify(result.parsed))</span><br></pre></td></tr></table></figure>
<p>修改 package.json 中 start 和 build 命令：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"start": "profile=dev node env.js &amp;&amp; react-scripts start",</span><br><span class="line">"build": "node env.js &amp;&amp; react-scripts build",</span><br></pre></td></tr></table></figure>
<p>可以看到我为本地开发配置的 profile 是 dev。production 上所用的 profile 以构建系统（jenkins虚拟机）所提供的 profile 为准。</p>
<h2><span id="可以提升的点">可以提升的点。</span></h2>
<p>未来，如果有时间的话，还可以做一些提升。</p>
<p>相对容易的，在 build 结束后删除 .env 文件。简单的做法是, build 完成后再调用删除命令。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">"build": "node env.js &amp;&amp; react-scripts build &amp;&amp; node env.js cleanup",</span><br></pre></td></tr></table></figure>
<p>复杂一点的，完全弃用 .env 文件，通过子进程来调用 build 脚本，同时设置环境变量。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">'child_process'</span>).exec(<span class="string">'api_path=xxx react-scripts build'</span>)</span><br></pre></td></tr></table></figure>
<h2><span id="总结和感想">总结和感想</span></h2>
<p>cra 官方只提供了区分开发和线上的环境变量管理办法，其实一开始就已经表明了他们绝对无法支持多线上环境这个现实，但是我还是愚蠢的尝试了几个小时，试图从多种配置文件的组合中寻找一种可以利用的模式，现在看起来这注定是要失败的。</p>
<p>我现在所“发明”的这种方式，其实就是简单的改变了思路：既然 cra 不支持多 profile，那我利用外部脚本按需生成 env 文件然后提供给 cra 不是一样解决问题吗？当然，到底要利用 lib 本身还是外部服务（脚本，其他lib）来解决问题，要综合考虑时间成本，可靠性。</p>
</main></article></section><footer><section class="links"> <a href="atom.xml"> <span class="icon" name="rss"></span></a><a href="https://github.com/wangpin34"> <span class="icon" name="github"></span></a><a href="https://hexo.io">Hexo</a></section><section class="copyright">© 2019 王品</section></footer></body></html>